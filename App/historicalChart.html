<!doctype html>
<html lang="en">
    <head>
        <title>Liuyin Huang's Homework</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://code.highcharts.com/stock/highstock.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.2/moment.js"></script>
    </head>

    <body>
        <div id="chart_container"></div>
    </body>


    <script>
        var base_url = "http://localhost:3000/";
        // var base_url = "http://10.0.2.2:3000/";

        var finishedCharts = 0; //needs to be 1 (1 price)
        function getFinishedNum(){
            return finishedCharts;
        }

        var priceJsonObj;
        
        interfaceInitiate('AAPL');

        //for java class to call
        function interfaceInitiate(symbol){
            fetchPrice(symbol); //fetch price data, create chart after data fechted
        }


        function fetchPrice(symbol) {
            $.ajax({
                url: base_url + "price?symbol=" + symbol, 
                success: function(result){
                    priceJsonObj = result;
                    finishedCharts++;
                    createStockChart();
                },
                async: true
            });
        }

        //highStock
        function createStockChart(){
            //use priceJsonObj
            var meta = priceJsonObj['Meta Data'];
            var symbol = meta['2. Symbol']; //full name
            var ori_data = priceJsonObj['Time Series (Daily)']; //full size data
            parseRes = parseStockData(ori_data);

            Highcharts.stockChart('chart_container', {
                chart: { width: null },
                title: { text: symbol + ' Stock Value' },
                subtitle: {
                  useHTML:true,
                  text: "<a target='_blank' style='text-decoration: none' href='https://www.alphavantage.co/'>Source: Alpha Vantage</a>"
                },
                rangeSelector: { selected: 1 },
                series: [{
                  name: symbol,
                  data: parseRes,
                  type: 'area',
                  threshold: null,
                  tooltip: { valueDecimals: 2 }
                }],
                responsive: {
                  rules: [{
                      condition: { maxWidth: 500 },
                      chartOptions: {
                          chart: { height: 300 },
                          subtitle: { text: null },
                          navigator: { enabled: false }
                      }
                  }]
                }
            });
        }


        function parseStockData(jsonObj){
            var cnt = 0, combinedData = [] //[[ms, price], [ms, price], [ms, price]... [ms, price]]
            var array_date = [], array_price = [];
            for(var key in jsonObj) {
                if(cnt++ >= 1000) break;
                var date = moment(key, "YYYY-MM-DD").valueOf(); //key = "2017-10-19"
                array_date.push(date);
                array_price.push(parseFloat(jsonObj[key]['4. close']));
            }
            array_date.reverse();
            array_price.reverse();

            for(var i = 0; i < array_date.length; i++){
                var tmp = [];
                tmp.push(array_date[i]); tmp.push(array_price[i]);
                combinedData.push(tmp);
            }
            return combinedData;
        }

    </script>
</html>
